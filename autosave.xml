<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Monday, June 14, 2021, 11:32 AM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "autosave" generated by Plugin Wizard -->

<muclient>
<plugin
   name="autosave"
   author="Naricain"
   id="9d256e3fdb93859478db469d"
   language="Lua"
   purpose="Autosave the world file when there are any changes"
   save_state="y"
   date_written="2021-06-14 11:31:18"
   requires="5.00"
   version="1.0"
   >

</plugin>
<timers>
  <timer enabled="y" second="1.00" offset_second="0.00" send_to="12" script="do_autosave" />
</timers>
<aliases>
  <alias
    match="^autosave (on|off|show|now*)$"
    script="autosave_cmd"
    regexp="y"
    ignore_case="y"
    enabled="y"
  >
  </alias>
  <alias
    match="^autosave interval ([0-9]+)$"
    script="autosave_interval"
    regexp="y"
    ignore_case="y"
    enabled="y"
  >
  </alias>
</aliases>
<script>
<![CDATA[
  local last_save = os.clock()
  local AUTOSAVE_INTERVAL = 60 * 10 -- 10 minutes apart
  local autoSave = GetVariable("autoSave") or "on"
  local blocking = false

  function do_autosave()
    if GetInfo(111) or last_save + AUTOSAVE_INTERVAL < os.clock() then
      if(autoSave == "on" and blocking == false) then
        Save()
        ColourNote("white", "blue", "World file saved.")
        last_save = os.clock()
      end
    end
  end

	function autosave_cmd(name, line, wildcards)
		if (not wildcards[1] or wildcards[1] == "" or wildcards[1] == "show") then
			ColourNote("white", "blue","Autosave currently set to: '"..autoSave.. "'")
			if(autoSave == "on") then
        ColourNote("white", "blue","Autosave interval set to: "..AUTOSAVE_INTERVAL.. " seconds")
        ColourNote("white", "blue","Next autosave in: "..(AUTOSAVE_INTERVAL-(os.clock()-last_save)).. " seconds")
      end
		elseif (wildcards[1] == "now") then
      last_save = 0
      do_autosave()
    else
			autoSave = wildcards[1]:lower()
			SetVariable("autoSave", autoSave)
			ColourNote("white", "blue","Autosave is now set to: '".. autoSave.. "'")
		end
	end
  
  function autosave_interval(name, line, wildcards)
    AUTOSAVE_INTERVAL = tonumber(Trim(wildcards[1])) or 60 * 10
    ColourNote("white", "blue","Autosave interval set to: ".. AUTOSAVE_INTERVAL.. " seconds.")
  end
  
  function OnPluginBroadcast(msg, id, name, text)
    if (id == 'b6eae87ccedd84f510b74714') then
      if (msg == 999) then
        if (text == 'ok_you_can_go_now') then
          blocking = false
          --ColourNote("white", "green","You can save now!!!") 
        else
          blocking = true
          --ColourNote("white", "red","Do not save !!!") 
        end
      end
    end
  end

]]>
</script>


</muclient>
